<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
    <script>
        // !! IMPORTANT !!
        // Replace these with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();
    </script>

    <meta name="google-site-verification" content="YOUR_UNIQUE_GOOGLE_VERIFICATION_CODE" />
    <title>YarikOgraf - Надихаюсь життям природи та її красою</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS custom configuration for colors and font family
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Custom font family 'Inter'
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Custom color 'brand-red'
                        'brand-red': '#D41811',
                        'light-gray': '#f8f8f8',
                        'dark-gray-bg': '#1a1a1a',
                        'medium-gray-text': '#b0b0b0',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="style.css">
    <style>
        .calendar-day.has-donations {
            background-color: #D41811; /* Highlight days with donations */
            color: white;
            font-weight: bold;
        }
        .calendar-day.selected-day {
            border: 2px solid #D41811;
            box-shadow: 0 0 8px rgba(212, 24, 17, 0.5);
        }
    </style>
</head>
<body class="font-inter bg-dark-gray-bg text-medium-gray-text">

    <header class="bg-black text-white p-6 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="text-3xl font-bold text-brand-red">YarikOgraf</a>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="index.html" class="hover:text-brand-red transition-colors">Головна</a></li>
                    <li><a href="gallery.html" class="hover:text-brand-red transition-colors">Галерея</a></li>
                    <li><a href="about.html" class="hover:text-brand-red transition-colors">Про мене</a></li>
                    <li><a href="contact.html" class="hover:text-brand-red transition-colors">Контакти</a></li>
                    <li><a href="login.html" class="hover:text-brand-red transition-colors">Адмін</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-8 mt-8 bg-black rounded-lg shadow-xl">
        <section class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-white mb-4">Надихаюсь життям природи та її красою</h1>
            <p class="text-xl text-light-gray leading-relaxed">
                Досліджую та захоплююся світом природи через об'єктив камери.
                Мої фотографії - це спроба передати неповторну красу та велич кожного моменту.
            </p>
            <a href="gallery.html" class="mt-8 inline-block bg-brand-red text-white text-xl font-semibold py-4 px-10 rounded-full shadow-lg hover:bg-red-700 transition-all duration-300 transform hover:scale-105">
                Переглянути роботи
            </a>
        </section>

        <section class="mb-12">
            <h2 class="text-4xl font-bold text-white mb-8 text-center">Календар Донатів</h2>
            <p class="text-lg text-light-gray mb-6 text-center">Оберіть день, щоб побачити топ донаторів.</p>

            <div class="flex flex-col items-center">
                <div class="calendar bg-gray-800 p-6 rounded-lg shadow-lg max-w-xl w-full">
                    <div class="calendar-header flex justify-between items-center mb-4">
                        <button id="prevMonth" class="text-white text-2xl px-3 py-1 rounded-full hover:bg-gray-700 transition-colors">&lt;</button>
                        <h2 id="currentMonthYear" class="text-white text-2xl font-semibold"></h2>
                        <button id="nextMonth" class="text-white text-2xl px-3 py-1 rounded-full hover:bg-gray-700 transition-colors">&gt;</button>
                    </div>
                    <div class="calendar-weekdays grid grid-cols-7 gap-2 text-center text-gray-400 mb-2">
                        <span>Пн</span><span>Вт</span><span>Ср</span><span>Чт</span><span>Пт</span><span>Сб</span><span>Нд</span>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 gap-2 text-center">
                        </div>
                </div>

                <div class="mt-8 text-center bg-gray-800 p-6 rounded-lg shadow-lg max-w-xl w-full">
                    <h3 class="text-2xl font-bold text-white mb-4">Обрана Дата: <span id="selectedDateDisplay" class="text-brand-red">Не обрано</span></h3>
                    <div id="topDonatorsList" class="text-light-gray">
                        <p>Оберіть день на календарі, щоб побачити донаторів.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-black text-white p-6 mt-12 text-center">
        <p>&copy; 2023 YarikOgraf. Усі права захищено.</p>
    </footer>

    <script>
        const daysContainer = document.getElementById('calendar-days');
        const currentMonthYearDisplay = document.getElementById('currentMonthYear');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const topDonatorsListElement = document.getElementById('topDonatorsList');

        let currentDate = new Date();
        let selectedDayElement = null; // To keep track of the currently selected day HTML element

        const db = firebase.firestore(); // Initialize Firestore

        async function getDonationDataForMonth(year, month) {
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0, 23, 59, 59); // Last second of the month

            const donationsRef = db.collection('donations');
            const snapshot = await donationsRef
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            const donationDates = new Set();
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.date && data.date.toDate) { // Ensure it's a Firestore Timestamp
                    donationDates.add(data.date.toDate().toISOString().split('T')[0]);
                }
            });
            return donationDates;
        }

        async function updateTopDonatorsList(dateString, limit = 5) {
            topDonatorsListElement.innerHTML = ''; // Clear previous list
            if (!dateString) {
                topDonatorsListElement.innerHTML = '<p>Оберіть день на календарі, щоб побачити донаторів.</p>';
                return;
            }

            const selectedDateStart = new Date(dateString);
            selectedDateStart.setHours(0, 0, 0, 0);
            const selectedDateEnd = new Date(dateString);
            selectedDateEnd.setHours(23, 59, 59, 999);

            try {
                const donationsRef = db.collection('donations');
                const snapshot = await donationsRef
                    .where('date', '>=', selectedDateStart)
                    .where('date', '<=', selectedDateEnd)
                    .orderBy('amount', 'desc') // Order by amount descending
                    .limit(limit)
                    .get();

                if (snapshot.empty) {
                    topDonatorsListElement.innerHTML = `<p>На ${selectedDateDisplay.textContent} донатів немає.</p>`;
                    return;
                }

                const donators = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const name = data.name || 'Анонім';
                    const amount = data.amount || 0;
                    donators.push({ name, amount });
                });

                let donatorHtml = `<p class="font-bold text-white mb-2">Топ донаторів за ${selectedDateDisplay.textContent}:</p><ul>`;
                donators.forEach(donator => {
                    donatorHtml += `<li>${donator.name}: ${donator.amount} грн</li>`;
                });
                donatorHtml += `</ul>`;
                topDonatorsListElement.innerHTML = donatorHtml;

            } catch (error) {
                console.error("Error fetching donators:", error);
                topDonatorsListElement.innerHTML = '<p>Помилка завантаження списку донаторів.</p>';
            }
        }


        async function renderCalendar() {
            daysContainer.innerHTML = ''; // Clear previous days
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            currentMonthYearDisplay.textContent = new Date(year, month).toLocaleDateString('uk-UA', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Adjust firstDayOfMonth for Monday start (0 for Sunday, 1 for Monday, ..., 6 for Saturday)
            const startDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

            const donationDates = await getDonationDataForMonth(year, month);

            // Add empty divs for leading blank days
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('p-2');
                daysContainer.appendChild(emptyDay);
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day', 'p-2', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-700', 'transition-colors');
                dayElement.textContent = day;

                const dateValue = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayElement.dataset.date = dateValue;

                if (donationDates.has(dateValue)) {
                    dayElement.classList.add('has-donations');
                }

                // If this day was previously selected (after a month change)
                if (selectedDayElement && selectedDayElement.dataset.date === dateValue) {
                    dayElement.classList.add('selected-day', 'border-yo-red');
                    selectedDayElement = dayElement; // Update the reference
                }

                daysContainer.appendChild(dayElement);
            }

            // Add click listeners to new day elements
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.addEventListener('click', function() {
                    // Remove selected class from previously selected day
                    if (selectedDayElement) {
                        selectedDayElement.classList.remove('selected-day', 'border-yo-red');
                    }
                    // Add selected class to the newly clicked day
                    day.classList.add('selected-day', 'border-yo-red');
                    selectedDayElement = day; // Update reference to selected day

                    // Update the displayed selected date text
                    const dateValue = day.dataset.date;
                    const dateParts = dateValue.split('-');
                    const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); // Month is 0-indexed
                    const options = { day: 'numeric', month: 'long', year: 'numeric' };
                    selectedDateDisplay.textContent = date.toLocaleDateString('uk-UA', options);

                    updateTopDonatorsList(dateValue); // Fetch and display donators for the selected date
                });
            });
        }

        prevMonthButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            selectedDayElement = null; // Clear selected day on month change
            selectedDateDisplay.textContent = 'Не обрано';
            renderCalendar();
            updateTopDonatorsList(''); // Clear donators list
        });

        nextMonthButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            selectedDayElement = null; // Clear selected day on month change
            selectedDateDisplay.textContent = 'Не обрано';
            renderCalendar();
            updateTopDonatorsList(''); // Clear donators list
        });

        // Initial render
        renderCalendar();

        // Optional: If you want to keep the login form directly on index.html for some reason,
        // otherwise it's handled by login.html
        // Keeping it for now as per your original file, but recommending `login.html` as the dedicated page.
        document.getElementById('loginForm')?.addEventListener('submit', function(e){
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            firebase.auth().signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                // Check if the authenticated user's email matches the admin email
                if (user.email === "yarikphoto26@gmail.com") { // !! IMPORTANT: Consider storing admin email more securely
                    window.location.href = "admin.html"; // Redirect to admin page
                } else {
                    alert("Ви не маєте доступу!");
                    firebase.auth().signOut(); // Log out non-admin users
                }
            })
            .catch((error) => {
                alert("Помилка входу: " + error.message);
                console.error("Login Error:", error);
            });
        });
    </script>
</body>
</html>
