<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YarikOgraf Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js"></script>

    <script>
        // !! ВАЖЛИВО !!
        // Замініть це на свою фактичну конфігурацію проекту Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // <--- ЗАМІНІТЬ ЦЕ
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <--- ЗАМІНІТЬ ЦЕ
            projectId: "YOUR_PROJECT_ID", // <--- ЗАМІНІТЬ ЦЕ
            storageBucket: "YOUR_PROJECT_ID.appspot.com", // <--- ЗАМІНІТЬ ЦЕ
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // <--- ЗАМІНІТЬ ЦЕ
            appId: "YOUR_APP_ID" // <--- ЗАМІНІТЬ ЦЕ
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Перевірка стану авторизації при завантаженні сторінки
        auth.onAuthStateChanged(user => {
            // !! УВАГА: Це базова перевірка. Для виробництва використовуйте Firebase Custom Claims
            // або зберігайте UID адмінів у Firestore для більшої безпеки.
            if (!user || user.email !== "yarikphoto26@gmail.com") { // Перевірка email адміна
                alert("У вас немає доступу до цієї сторінки.");
                window.location.href = "login.html"; // Перенаправлення на сторінку входу
            }
        });
    </script>

    <style>
        :root {
            --primary-color: #D41811; /* Your brand red */
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --dark-text: #343a40;
            --border-color: #dee2e6;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-text);
        }

        input[type="text"],
        input[type="number"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box; /* Ensures padding doesn't add to width */
            margin-top: 5px;
        }

        input[type="file"] {
            margin-top: 10px;
        }

        button {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            color: #fff;
            margin-right: 10px;
        }

        button.primary {
            background-color: var(--primary-color);
        }
        button.primary:hover {
            background-color: #a9130d;
        }

        button.success {
            background-color: var(--success-color);
        }
        button.success:hover {
            background-color: #218838;
        }

        button.danger {
            background-color: var(--danger-color);
        }
        button.danger:hover {
            background-color: #c82333;
        }

        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #545b62;
        }

        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .gallery-list {
            margin-top: 30px;
        }

        .gallery-item {
            display: flex;
            align-items: center;
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .gallery-item img, .gallery-item video {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
        }
        .gallery-item iframe {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            margin-right: 15px;
            border: none;
        }

        .item-details {
            flex-grow: 1;
            text-align: left;
        }

        .item-details h3 {
            margin: 0 0 5px 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .item-details p {
            margin: 0;
            font-size: 0.9rem;
            color: #555;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .item-actions button {
            padding: 8px 12px;
            font-size: 0.85rem;
            margin: 0; /* Override default button margin */
        }

        .status-paid {
            color: var(--success-color);
            font-weight: bold;
        }

        .status-unpaid {
            color: var(--danger-color);
            font-weight: bold;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid var(--primary-color); /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .wayforpay-section {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Панель адміністратора YarikOgraf</h1>

        <button class="secondary" id="logoutButton">Вийти</button>

        <hr style="margin: 25px 0; border-color: var(--border-color);">

        <h2>Додати новий елемент галереї</h2>
        <div id="statusMessage" class="alert" style="display:none;"></div>

        <form id="galleryItemForm">
            <input type="hidden" id="itemId" value="">
            <div class="form-group">
                <label for="title">Заголовок:</label>
                <input type="text" id="title" required>
            </div>
            <div class="form-group">
                <label for="description">Опис:</label>
                <textarea id="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="price">Ціна (грн):</label>
                <input type="number" id="price" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="fileUpload">Завантажити файл (фото/відео) в Firebase Storage:</label>
                <input type="file" id="fileUpload" accept="image/*,video/*">
            </div>
            <div class="form-group">
                <label for="googleDriveUrl">АБО Вставте Google Drive URL (для файлів з Google Drive):</label>
                <input type="url" id="googleDriveUrl" placeholder="Наприклад: https://drive.google.com/file/d/YOUR_FILE_ID/view?usp=sharing">
                <p style="font-size: 0.8em; color: #777; margin-top: 5px;">
                    Переконайтесь, що файл на Google Drive доступний для перегляду за посиланням ("Anyone with the link can view").
                </p>
            </div>
            <div class="form-group">
                <label for="itemType">Тип елемента:</label>
                <select id="itemType" required>
                    <option value="">Оберіть тип</option>
                    <option value="image">Фото</option>
                    <option value="video">Відео</option>
                </select>
            </div>
            <div class="form-group">
                <label for="isPaid">Оплачено (для тестових цілей):</label>
                <input type="checkbox" id="isPaid">
            </div>

            <button type="submit" class="primary" id="saveButton">Додати / Оновити</button>
            <button type="button" class="secondary" id="clearFormButton" style="display:none;">Очистити форму</button>
        </form>

        <hr style="margin: 25px 0; border-color: var(--border-color);">

        <h2>Існуючі елементи галереї</h2>
        <div id="galleryList">
            <p>Завантаження елементів...</p>
        </div>

        <div class="wayforpay-section">
            <h2>Додати донат (вручну для тесту)</h2>
            <div class="form-group">
                <label for="donorName">Ім'я донатора (необов'язково):</label>
                <input type="text" id="donorName" placeholder="Анонім">
            </div>
            <div class="form-group">
                <label for="donationAmount">Сума донату (грн):</label>
                <input type="number" id="donationAmount" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="donationDate">Дата донату:</label>
                <input type="date" id="donationDate" required>
            </div>
            <button type="button" class="success" id="addDonationButton">Додати донат</button>
            <div id="donationStatusMessage" class="alert" style="display:none; margin-top: 15px;"></div>
        </div>

    </div>

    <script>
        // Helper function to extract Google Drive File ID
        function getGoogleDriveFileId(url) {
            const regex = /(?:id=|folders\/)([a-zA-Z0-9_-]{28,})/i;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // Helper function to convert Google Drive share link to direct embed/preview link
        // This is only for displaying previews in the admin panel and public gallery.
        // For secure downloads, a backend is required.
        function convertDriveLinkForPreview(driveUrl, type = 'image') {
            const fileId = getGoogleDriveFileId(driveUrl);
            if (fileId) {
                if (type === 'image') {
                    return `https://lh3.googleusercontent.com/d/${fileId}=s200`; // Smaller preview for admin
                } else if (type === 'video') {
                    return `https://drive.google.com/file/d/${fileId}/preview`;
                }
            }
            return null;
        }

        // DOM Elements
        const logoutButton = document.getElementById('logoutButton');
        const galleryItemForm = document.getElementById('galleryItemForm');
        const itemIdField = document.getElementById('itemId');
        const titleField = document.getElementById('title');
        const descriptionField = document.getElementById('description');
        const priceField = document.getElementById('price');
        const fileUploadField = document.getElementById('fileUpload');
        const googleDriveUrlField = document.getElementById('googleDriveUrl');
        const itemTypeField = document.getElementById('itemType');
        const isPaidField = document.getElementById('isPaid');
        const saveButton = document.getElementById('saveButton');
        const clearFormButton = document.getElementById('clearFormButton');
        const statusMessage = document.getElementById('statusMessage');
        const galleryList = document.getElementById('galleryList');

        const addDonationButton = document.getElementById('addDonationButton');
        const donorNameField = document.getElementById('donorName');
        const donationAmountField = document.getElementById('donationAmount');
        const donationDateField = document.getElementById('donationDate');
        const donationStatusMessage = document.getElementById('donationStatusMessage');

        let currentEditingItem = null; // To keep track of the item being edited

        // --- Authentication & Logout ---
        logoutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = "login.html";
            } catch (error) {
                console.error("Помилка виходу:", error);
                alert("Помилка виходу.");
            }
        });

        // --- Gallery Item Management ---
        galleryItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveButton.disabled = true;
            saveButton.textContent = 'Збереження...';
            statusMessage.style.display = 'none';

            const title = titleField.value;
            const description = descriptionField.value;
            const price = parseFloat(priceField.value);
            const file = fileUploadField.files[0];
            const googleDriveUrl = googleDriveUrlField.value;
            const itemType = itemTypeField.value;
            const isPaid = isPaidField.checked;

            if (!title || isNaN(price) || price < 0 || !itemType) {
                showMessage("Заповніть всі обов'язкові поля: Заголовок, Ціна, Тип.", "danger");
                saveButton.disabled = false;
                saveButton.textContent = 'Додати / Оновити';
                return;
            }

            if (!file && !googleDriveUrl) {
                showMessage("Будь ласка, завантажте файл АБО вкажіть Google Drive URL.", "danger");
                saveButton.disabled = false;
                saveButton.textContent = 'Додати / Оновити';
                return;
            }
            if (file && googleDriveUrl) {
                showMessage("Будь ласка, оберіть ОДИН метод: або завантажте файл, або вкажіть Google Drive URL.", "danger");
                saveButton.disabled = false;
                saveButton.textContent = 'Додати / Оновити';
                return;
            }

            try {
                let downloadURL = null;
                let fileName = null;

                if (file) {
                    // Upload to Firebase Storage
                    fileName = file.name;
                    const storageRef = storage.ref('gallery/' + fileName);
                    const uploadTask = storageRef.put(file);

                    // Show upload progress (optional)
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            saveButton.textContent = `Завантаження... ${progress.toFixed(0)}%`;
                        },
                        (error) => {
                            console.error("Помилка завантаження файлу:", error);
                            showMessage(`Помилка завантаження файлу: ${error.message}`, "danger");
                            saveButton.disabled = false;
                            saveButton.textContent = 'Додати / Оновити';
                        },
                        async () => {
                            downloadURL = await storageRef.getDownloadURL();
                            saveItemToFirestore(title, description, price, downloadURL, null, itemType, fileName, isPaid);
                        }
                    );
                } else if (googleDriveUrl) {
                    // Use Google Drive URL directly
                    fileName = googleDriveUrl.substring(googleDriveUrl.lastIndexOf('/') + 1); // Simple extraction, may need refinement
                    await saveItemToFirestore(title, description, price, null, googleDriveUrl, itemType, fileName, isPaid);
                }

            } catch (error) {
                console.error("Помилка при збереженні елемента галереї:", error);
                showMessage(`Помилка: ${error.message}`, "danger");
                saveButton.disabled = false;
                saveButton.textContent = 'Додати / Оновити';
            }
        });

        async function saveItemToFirestore(title, description, price, url, driveUrl, itemType, fileName, isPaid) {
            const itemData = {
                title,
                description,
                price,
                url,          // Firebase Storage URL
                driveUrl,     // Google Drive URL
                type: itemType,
                fileName,
                paid: isPaid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp() // Timestamp for ordering
            };

            try {
                if (currentEditingItem) {
                    // Update existing item
                    await db.collection('galleryItems').doc(currentEditingItem.id).update(itemData);
                    showMessage("Елемент успішно оновлено!", "success");
                } else {
                    // Add new item
                    await db.collection('galleryItems').add(itemData);
                    showMessage("Елемент успішно додано!", "success");
                }
                clearForm();
                loadGalleryItems(); // Reload gallery to show changes
            } catch (error) {
                console.error("Помилка збереження в Firestore:", error);
                showMessage(`Помилка збереження в Firestore: ${error.message}`, "danger");
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Додати / Оновити';
            }
        }

        function showMessage(msg, type) {
            statusMessage.textContent = msg;
            statusMessage.className = `alert alert-${type}`;
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        function clearForm() {
            itemIdField.value = '';
            titleField.value = '';
            descriptionField.value = '';
            priceField.value = '';
            fileUploadField.value = ''; // Clear selected file
            googleDriveUrlField.value = '';
            itemTypeField.value = '';
            isPaidField.checked = false;
            currentEditingItem = null;
            saveButton.textContent = 'Додати / Оновити';
            clearFormButton.style.display = 'none';
        }

        clearFormButton.addEventListener('click', clearForm);

        // --- Load & Display Gallery Items ---
        async function loadGalleryItems() {
            galleryList.innerHTML = '<p>Завантаження елементів...</p>';
            try {
                const snapshot = await db.collection('galleryItems').orderBy('createdAt', 'desc').get();
                galleryList.innerHTML = ''; // Clear loading message

                if (snapshot.empty) {
                    galleryList.innerHTML = '<p>Наразі в галереї немає елементів.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    renderGalleryItem(item);
                });
            } catch (error) {
                console.error("Помилка завантаження елементів галереї:", error);
                galleryList.innerHTML = `<p class="alert alert-danger">Помилка завантаження галереї: ${error.message}</p>`;
            }
        }

        function renderGalleryItem(item) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('gallery-item');

            let mediaHtml = '';
            let previewUrl = '';

            if (item.url) { // Firebase Storage URL
                if (item.type && item.type.startsWith('image')) {
                    previewUrl = item.url;
                    mediaHtml = `<img src="${previewUrl}" alt="${item.title}">`;
                } else if (item.type && item.type.startsWith('video')) {
                    previewUrl = item.url;
                    mediaHtml = `<video src="${previewUrl}" controls muted width="80" height="80"></video>`;
                }
            } else if (item.driveUrl) { // Google Drive URL
                previewUrl = convertDriveLinkForPreview(item.driveUrl, item.type);
                if (item.type === 'image') {
                    mediaHtml = `<img src="${previewUrl}" alt="${item.title}">`;
                } else if (item.type === 'video') {
                    mediaHtml = `<iframe src="${previewUrl}" frameborder="0" allowfullscreen></iframe>`;
                }
            }


            itemDiv.innerHTML = `
                ${mediaHtml}
                <div class="item-details">
                    <h3>${item.title}</h3>
                    <p>${item.description}</p>
                    <p>Ціна: <strong>${item.price} грн</strong></p>
                    <p>Статус: <span class="${item.paid ? 'status-paid' : 'status-unpaid'}">${item.paid ? 'Оплачено' : 'Не оплачено'}</span></p>
                    <p>Джерело: ${item.driveUrl ? 'Google Drive' : (item.url ? 'Firebase Storage' : 'Невідомо')}</p>
                    <p style="font-size: 0.8em; color: #888;">Створено: ${item.createdAt ? new Date(item.createdAt.toDate()).toLocaleString('uk-UA') : 'Невідомо'}</p>
                </div>
                <div class="item-actions">
                    <button class="primary" data-id="${item.id}" data-action="edit">Редагувати</button>
                    <button class="danger" data-id="${item.id}" data-action="delete">Видалити</button>
                    <button class="secondary" data-id="${item.id}" data-action="toggle-paid">${item.paid ? 'Зняти оплату' : 'Позначити як оплачено'}</button>
                </div>
            `;
            galleryList.appendChild(itemDiv);
        }

        // --- Edit, Delete, Toggle Paid actions ---
        galleryList.addEventListener('click', async (e) => {
            const target = e.target;
            const itemId = target.dataset.id;
            const action = target.dataset.action;

            if (!itemId) return;

            if (action === 'edit') {
                const itemDoc = await db.collection('galleryItems').doc(itemId).get();
                if (itemDoc.exists) {
                    const item = { id: itemDoc.id, ...itemDoc.data() };
                    currentEditingItem = item;
                    itemIdField.value = item.id;
                    titleField.value = item.title;
                    descriptionField.value = item.description;
                    priceField.value = item.price;
                    googleDriveUrlField.value = item.driveUrl || '';
                    fileUploadField.value = ''; // Clear file input when editing (user can re-upload if needed)
                    itemTypeField.value = item.type || '';
                    isPaidField.checked = item.paid || false;
                    saveButton.textContent = 'Оновити елемент';
                    clearFormButton.style.display = 'inline-block';
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to form
                }
            } else if (action === 'delete') {
                if (confirm('Ви впевнені, що хочете видалити цей елемент?')) {
                    try {
                        // If file was in Firebase Storage, delete it too
                        const itemDoc = await db.collection('galleryItems').doc(itemId).get();
                        if (itemDoc.exists && itemDoc.data().url) {
                            const fileRef = storage.refFromURL(itemDoc.data().url);
                            await fileRef.delete();
                            console.log("Файл видалено з Firebase Storage.");
                        }
                        await db.collection('galleryItems').doc(itemId).delete();
                        showMessage("Елемент успішно видалено!", "success");
                        loadGalleryItems();
                    } catch (error) {
                        console.error("Помилка видалення елемента:", error);
                        showMessage(`Помилка видалення елемента: ${error.message}`, "danger");
                    }
                }
            } else if (action === 'toggle-paid') {
                try {
                    const itemDoc = await db.collection('galleryItems').doc(itemId).get();
                    if (itemDoc.exists) {
                        const currentPaidStatus = itemDoc.data().paid || false;
                        await db.collection('galleryItems').doc(itemId).update({ paid: !currentPaidStatus });
                        showMessage(`Статус оплати змінено на: ${!currentPaidStatus ? 'Оплачено' : 'Не оплачено'}`, "success");
                        loadGalleryItems();
                    }
                } catch (error) {
                    console.error("Помилка зміни статусу оплати:", error);
                    showMessage(`Помилка зміни статусу оплати: ${error.message}`, "danger");
                }
            }
        });

        // --- Donation Management (Manual for testing) ---
        addDonationButton.addEventListener('click', async () => {
            donationStatusMessage.style.display = 'none';
            const donorName = donorNameField.value || 'Анонім';
            const donationAmount = parseFloat(donationAmountField.value);
            const donationDate = donationDateField.value; // YYYY-MM-DD

            if (isNaN(donationAmount) || donationAmount <= 0 || !donationDate) {
                donationStatusMessage.textContent = "Будь ласка, введіть коректну суму донату та дату.";
                donationStatusMessage.className = 'alert alert-danger';
                donationStatusMessage.style.display = 'block';
                return;
            }

            try {
                await db.collection('donations').add({
                    donorName: donorName,
                    amount: donationAmount,
                    date: donationDate, // Store as YYYY-MM-DD string
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                donationStatusMessage.textContent = "Донат успішно додано!";
                donationStatusMessage.className = 'alert alert-success';
                donationStatusMessage.style.display = 'block';
                donorNameField.value = '';
                donationAmountField.value = '';
                donationDateField.value = '';
            } catch (error) {
                console.error("Помилка додавання донату:", error);
                donationStatusMessage.textContent = `Помилка додавання донату: ${error.message}`;
                donationStatusMessage.className = 'alert alert-danger';
                donationStatusMessage.style.display = 'block';
            }
        });


        // Initial load of gallery items when admin page loads
        loadGalleryItems();
    </script>
</body>
</html>
